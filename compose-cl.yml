# Override any defaults specified by `${FOO:-bar}` in `.env` with `FOO=qux`.
# ${VARIABLE:-default} evaluates to default if VARIABLE is unset or empty in the environment.
# ${VARIABLE-default} evaluates to default only if VARIABLE is unset in the environment.

services:
  #                            _ _
  #   __ _ _ __ __ _ _ __   __| (_)_ __   ___
  #  / _` | '__/ _` | '_ \ / _` | | '_ \ / _ \
  # | (_| | | | (_| | | | | (_| | | | | |  __/
  #  \__, |_|  \__,_|_| |_|\__,_|_|_| |_|\___|
  #  |___/

  cl-grandine:
    profiles: [cl-grandine]
    image: sifrai/grandine:${GRANDINE_VERSION:-1.1.1}
    restart: unless-stopped
    command:
      - --datadir=/root/.grandine
      - --eth1-rpc-urls=http://${EL}:8551
      - --jwt-secret=/jwt
      - --http-address=0.0.0.0
      - --http-port=5052
      - --network=${NETWORK}
      - --metrics
      - --metrics-port=5054
      - --metrics-address=0.0.0.0
      - --checkpoint-sync-url=${LIGHTHOUSE_CHECKPOINT_SYNC_URL}
      - --builder=http://${MEV}:18550
    ports:
      - 9000:9000 # TCP + UDP LibP2P
    volumes:
      - ./data/grandine:/root/.grandine
      - ./jwt:/jwt:ro
    networks:
      - dvnode

  #  _ _       _     _   _
  # | (_) __ _| |__ | |_| |__   ___  _   _ ___  ___
  # | | |/ _` | '_ \| __| '_ \ / _ \| | | / __|/ _ \
  # | | | (_| | | | | |_| | | | (_) | |_| \__ \  __/
  # |_|_|\__, |_| |_|\__|_| |_|\___/ \__,_|___/\___|
  #      |___/

  cl-lighthouse:
    profiles: [cl-lighthouse]
    image: sigp/lighthouse:${LIGHTHOUSE_VERSION:-v7.0.1}
    ports:
      - ${LIGHTHOUSE_PORT_P2P:-9000}:9000/tcp # P2P TCP
      - ${LIGHTHOUSE_PORT_P2P:-9000}:9000/udp # P2P UDP
    labels:
      - "promtail-monitored=${LIGHTHOUSE_PROMTAIL_MONITORED:-true}"
    command: |
      lighthouse bn
      --network=${NETWORK}
      --checkpoint-sync-url=${LIGHTHOUSE_CHECKPOINT_SYNC_URL}
      --checkpoint-sync-url-timeout=600
      --execution-endpoint=http://${EL}:8551
      --execution-jwt=/opt/jwt/jwt.hex
      --datadir=/opt/app/beacon/
      --builder=http://${MEV}:18550
      --http
      --http-address=0.0.0.0
      --http-port=5052
      --metrics
      --metrics-address=0.0.0.0
      --metrics-port=5054
      --metrics-allow-origin="*"
      --suggested-fee-recipient=${LIDO_EXECUTION_LAYER_REWARDS_ADDRESS:-0x388C818CA8B9251b393131C08a736A67ccB19297}
    networks: [dvnode]
    volumes:
      - ./data/lighthouse:/opt/app/beacon
      - ./jwt:/opt/jwt
    restart: unless-stopped
